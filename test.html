<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Harveys Lake Ice Thickness Map – 2026 (Test)</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <style>
    body { margin: 0; }
    #map { height: 100vh; width: 100vw; }
    .legend {
      background: white;
      padding: 10px;
      line-height: 18px;
      color: #333;
      font-size: 14px;
      border-radius: 8px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>

  <!-- IMPORTANT: Leaflet needs this container -->
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    // 1) Map setup
    const map = L.map('map').setView([41.3665, -76.0535], 15);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // 2) Color bins (match legend)
    const BINS = [
      { min: 15, label: "15+", color: "#08306b" },
      { min: 13, label: "13–14.9", color: "#2171b5" },
      { min: 11, label: "11–12.9", color: "#41b6c4" },
      { min: 9,  label: "9–10.9",  color: "#feb24c" },
      { min: -Infinity, label: "≤ 8.9", color: "#de2d26" }
    ];

    function getColor(thickness) {
      for (const b of BINS) if (thickness >= b.min) return b.color;
      return "#999";
    }

    // 3) Season-long dataset (ADD MORE POINTS ALL WINTER)
    const measurements = [
      { lat: 41.36536, lon: -76.05671, thickness: 13.5, date: "2026-02-15", time: "15:52", notes: "" },
      { lat: 41.36458, lon: -76.05599, thickness: 13.5, date: "2026-02-15", time: "15:56", notes: "" },
      { lat: 41.36403, lon: -76.05496, thickness: 13.5, date: "2026-02-15", time: "15:59", notes: "" },
      { lat: 41.36473, lon: -76.05352, thickness: 13.5, date: "2026-02-15", time: "16:02", notes: "" },
      { lat: 41.36655, lon: -76.05417, thickness: 11.5, date: "2026-02-15", time: "16:07", notes: "" },
      { lat: 41.36631, lon: -76.05347, thickness: 11.5, date: "2026-02-15", time: "16:11", notes: "" },
      { lat: 41.36587, lon: -76.05152, thickness: 15.0, date: "2026-02-15", time: "16:16", notes: "" },
      { lat: 41.36670, lon: -76.04930, thickness: 13.5, date: "2026-02-15", time: "16:22", notes: "" },
      { lat: 41.36759, lon: -76.05027, thickness: 10.5, date: "2026-02-15", time: "16:26", notes: "" },
      { lat: 41.36845, lon: -76.05107, thickness: 12.5, date: "2026-02-15", time: "16:31", notes: "" },
      { lat: 41.36843, lon: -76.04916, thickness: 8.5,  date: "2026-02-15", time: "16:37", notes: "NE thinning zone" }
    ];

    // 4) Build a layer per date automatically
    const layersByDate = {};

    function formatPopup(m) {
      const coord = `${m.lat.toFixed(5)}, ${m.lon.toFixed(5)}`;
      const dt = m.time ? `${m.date} ${m.time}` : m.date;
      const noteLine = m.notes ? `<br><b>Notes:</b> ${m.notes}` : "";
      return `
        <div style="line-height:1.35">
          <b>Ice:</b> ${m.thickness.toFixed(1)} in<br>
          <b>Date:</b> ${dt}<br>
          <b>Coords:</b> ${coord}
          ${noteLine}
        </div>
      `;
    }

    measurements.forEach(m => {
      if (!layersByDate[m.date]) layersByDate[m.date] = L.layerGroup();

      const marker = L.circleMarker([m.lat, m.lon], {
        radius: 8,
        fillColor: getColor(m.thickness),
        color: "#000",
        weight: 1,
        fillOpacity: 0.9
      }).bindPopup(formatPopup(m));

      marker.addTo(layersByDate[m.date]);
    });

    // 5) Add layer control (toggle dates on/off)
    const overlays = {};
    Object.keys(layersByDate).sort().forEach(d => overlays[d] = layersByDate[d]);

    // Turn ON the latest date by default
    const datesSorted = Object.keys(layersByDate).sort();
    const latest = datesSorted[datesSorted.length - 1];
    layersByDate[latest].addTo(map);

    L.control.layers(null, overlays, { collapsed: false }).addTo(map);

    // 6) Legend
    const legend = L.control({ position: 'bottomright' });
    legend.onAdd = function() {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML += `<b>Ice Thickness (in)</b><br>`;
      BINS.forEach(b => {
        div.innerHTML += `<i style="background:${b.color};width:12px;height:12px;display:inline-block;margin-right:6px;"></i>${b.label}<br>`;
      });
      div.innerHTML += `<div style="margin-top:6px;font-size:12px;color:#555;"><b>Showing:</b> ${latest}</div>`;
      return div;
    };
    legend.addTo(map);
  </script>
</body>
</html>
