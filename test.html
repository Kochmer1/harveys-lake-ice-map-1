<script>
  // 1) Map setup
  const map = L.map('map').setView([41.3665, -76.0535], 15);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // 2) Color bins (match legend)
  const BINS = [
    { min: 15, label: "15+", color: "#08306b" },
    { min: 13, label: "13–14.9", color: "#2171b5" },
    { min: 11, label: "11–12.9", color: "#41b6c4" },
    { min: 9,  label: "9–10.9",  color: "#feb24c" },
    { min: -Infinity, label: "≤ 8.9", color: "#de2d26" }
  ];

  function getColor(thickness) {
    for (const b of BINS) if (thickness >= b.min) return b.color;
    return "#999";
  }

  // 3) Your season-long dataset (ADD TO THIS ALL WINTER)
  // Tip: keep date in YYYY-MM-DD format for sorting
  const measurements = [
    // --- 2026-02-15 set ---
    { lat: 41.36536, lon: -76.05671, thickness: 13.5, date: "2026-02-15", time: "15:52", notes: "" },
    { lat: 41.36458, lon: -76.05599, thickness: 13.5, date: "2026-02-15", time: "15:56", notes: "" },
    { lat: 41.36403, lon: -76.05496, thickness: 13.5, date: "2026-02-15", time: "15:59", notes: "" },
    { lat: 41.36473, lon: -76.05352, thickness: 13.5, date: "2026-02-15", time: "16:02", notes: "" },
    { lat: 41.36655, lon: -76.05417, thickness: 11.5, date: "2026-02-15", time: "16:07", notes: "" },
    { lat: 41.36631, lon: -76.05347, thickness: 11.5, date: "2026-02-15", time: "16:11", notes: "" },
    { lat: 41.36587, lon: -76.05152, thickness: 15.0, date: "2026-02-15", time: "16:16", notes: "" },
    { lat: 41.36670, lon: -76.04930, thickness: 13.5, date: "2026-02-15", time: "16:22", notes: "" },
    { lat: 41.36759, lon: -76.05027, thickness: 10.5, date: "2026-02-15", time: "16:26", notes: "" },
    { lat: 41.36845, lon: -76.05107, thickness: 12.5, date: "2026-02-15", time: "16:31", notes: "" },
    { lat: 41.36843, lon: -76.04916, thickness: 8.5,  date: "2026-02-15", time: "16:37", notes: "NE thinning zone" },

    // --- EXAMPLE future entry (copy this pattern) ---
    // { lat: 41.36610, lon: -76.05200, thickness: 9.0, date: "2026-02-22", time: "14:10", notes: "near pressure ridge" },
  ];

  // 4) Build a layer per date automatically
  const layersByDate = {}; // { "2026-02-15": L.layerGroup(), ... }

  function formatPopup(m) {
    const coord = `${m.lat.toFixed(5)}, ${m.lon.toFixed(5)}`;
    const dt = m.time ? `${m.date} ${m.time}` : m.date;
    const noteLine = m.notes ? `<br><b>Notes:</b> ${m.notes}` : "";
    return `
      <div style="line-height:1.35">
        <b>Ice:</b> ${m.thickness.toFixed(1)} in<br>
        <b>Date:</b> ${dt}<br>
        <b>Coords:</b> ${coord}
        ${noteLine}
      </div>
    `;
  }

  measurements.forEach(m => {
    if (!layersByDate[m.date]) layersByDate[m.date] = L.layerGroup();

    const marker = L.circleMarker([m.lat, m.lon], {
      radius: 8,
      fillColor: getColor(m.thickness),
      color: "#000",
      weight: 1,
      fillOpacity: 0.9
    }).bindPopup(formatPopup(m));

    marker.addTo(layersByDate[m.date]);
  });

  // 5) Add layer control (toggle dates on/off)
  const overlays = {};
  Object.keys(layersByDate).sort().forEach(d => {
    overlays[d] = layersByDate[d];
  });

  // Turn ON the latest date by default
  const datesSorted = Object.keys(layersByDate).sort();
  const latest = datesSorted[datesSorted.length - 1];
  layersByDate[latest].addTo(map);

  L.control.layers(null, overlays, { collapsed: false }).addTo(map);

  // 6) Legend (matches bins)
  const legend = L.control({ position: 'bottomright' });
  legend.onAdd = function() {
    const div = L.DomUtil.create('div', 'legend');
    div.style.background = "white";
    div.style.padding = "10px";
    div.style.lineHeight = "18px";
    div.style.color = "#333";
    div.style.fontSize = "14px";

    div.innerHTML += `<b>Ice Thickness (in)</b><br>`;
    BINS.forEach(b => {
      div.innerHTML +=
        `<i style="background:${b.color};width:12px;height:12px;display:inline-block;margin-right:6px;"></i>${b.label}<br>`;
    });
    div.innerHTML += `<div style="margin-top:6px;font-size:12px;color:#555;"><b>Showing:</b> ${latest}</div>`;
    return div;
  };
  legend.addTo(map);

  // Update the “Showing:” label when layers change
  map.on('overlayadd', function(e) {
    // If they turn on a date layer, update legend footer to that date
    const name = Object.keys(overlays).find(k => overlays[k] === e.layer);
    const legendDiv = document.querySelector('.legend');
    if (legendDiv && name) {
      // replace the last footer line (simple approach)
      const html = legendDiv.innerHTML.replace(/<div style="margin-top:6px.*<\/div>$/, '');
      legendDiv.innerHTML = html + `<div style="margin-top:6px;font-size:12px;color:#555;"><b>Showing:</b> ${name}</div>`;
    }
  });
</script>
